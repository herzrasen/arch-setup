- name: Set the timezone
  timezone:
    name: "{{ timezone }}"
    hwclock: UTC

- name: Generate the locale
  locale_gen: 
    name: "{{ locale }}"
    state: present

- name: Get the current locale
  command: localectl status
  register: locale_status
  changed_when: false

- name: Parse the current LANG from the configuration
  set_fact:
    current_locale: "{{ locale_status.stdout | regex_search('LANG=([^\n]+)', '\\1') | first }}"

- name: Set locale to "{{ locale }}" 
  command: localectl set-locale LANG="{{ locale }}"
  when: current_locale != locale

- name: Parse the current keymap from the configuration
  set_fact:
    current_keymap: "{{ locale_status.stdout | regex_search('VC Keymap: ([^\n]+)', '\\1') | first }}"

- name: Set the keymap
  command: localectl set-keymap {{ keymap }}
  when: current_keymap != keymap 

- name: Parse the current X11 keyboard layout
  set_fact:
    current_x11_layout: "{{ locale_status.stdout | regex_search('X11 Layout: ([^\n]+)', '\\1') | first }}"

- name: Parse the current X11 keyboard variant
  set_fact:
    current_x11_layout: "{{ locale_status.stdout | regex_search('X11 Model: ([^\n]+)', '\\1') | first }}"

- name: Set the X11 keyboard layout and variant
  command: localectl set-x11-keymap {{ x11_keyboard_layout }} {{ x11_keyboard_variant }} 
  when: current_x11_layout != x11_keyboard_layout or current_x11_variant != x11_keyboard_variant
